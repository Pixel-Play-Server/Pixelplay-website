<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Uber Eats</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'UberMove', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background:#f6f6f6; color:#000; line-height:1.4; }
        .header { background:#000; padding:16px 24px; position:sticky; top:0; z-index:1000; }
        .header-content { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
        .logo { font-size:24px; font-weight:900; color:#fff; letter-spacing:-0.5px; }
        .search-container { flex:1; min-width:220px; max-width:420px; position:relative; }
        .search-input { width:100%; padding:12px 16px; border:none; border-radius:8px; font-size:16px; background:#fff; transition:box-shadow 0.2s ease; }
        .search-input:focus { outline:none; box-shadow:0 0 0 2px #06c755; }
        .header-actions { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
        .btn { background:#06c755; color:#fff; border:none; padding:12px 16px; border-radius:500px; cursor:pointer; font-weight:600; font-size:14px; transition:background-color 0.2s ease; position:relative; }
        .btn:hover { background:#05b946; }
        .secondary-btn { background:#276ef1; }
        .secondary-btn:hover { background:#1747a6; }
        .link-btn { background:#111; }
        .link-btn:hover { background:#333; }
        .cart-count { position:absolute; top:-6px; right:-6px; background:#276ef1; color:white; border-radius:50%; width:20px; height:20px; display:none; align-items:center; justify-content:center; font-size:12px; font-weight:600; }
        .main-content { max-width:1200px; margin:0 auto; padding:40px 24px; }
        .hero-section { margin-bottom:48px; }
        .hero-title { font-size:52px; font-weight:900; color:#000; margin-bottom:16px; letter-spacing:-2px; line-height:1.1; }
        .hero-subtitle { font-size:18px; color:#545454; margin-bottom:32px; font-weight:400; }
        .restaurants-section { margin-top:48px; }
        .section-title { font-size:28px; font-weight:900; color:#000; margin-bottom:24px; letter-spacing:-0.5px; }
        .restaurants-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:24px; }
        .restaurant-card { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); transition:box-shadow 0.2s ease, transform 0.2s ease; cursor:pointer; border:1px solid #e8e8e8; }
        .restaurant-card:hover { box-shadow:0 4px 16px rgba(0,0,0,0.15); transform:translateY(-2px); }
        .restaurant-card.closed { opacity:0.7; cursor:not-allowed; }
        .restaurant-image { width:100%; height:200px; display:flex; align-items:center; justify-content:center; font-size:64px; position:relative; }
        .burger-joint-bg { background:linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%); }
        .leons-bbq-bg { background:linear-gradient(135deg, #8b4513 0%, #d2691e 100%); }
        .closed-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; color:#fff; font-size:20px; font-weight:700; letter-spacing:0.5px; }
        .restaurant-info { padding:16px; }
        .restaurant-name { font-size:20px; font-weight:700; color:#000; margin-bottom:4px; letter-spacing:-0.3px; }
        .restaurant-meta { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
        .rating { background:#000; color:#fff; padding:2px 8px; border-radius:4px; font-size:14px; font-weight:600; }
        .delivery-info { color:#545454; font-size:14px; }
        .restaurant-description { color:#737373; font-size:14px; margin-top:8px; }
        .menu-modal, .cart-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; overflow-y:auto; }
        .menu-content, .cart-content { background:#fff; max-width:800px; margin:80px auto 40px; border-radius:12px; overflow:hidden; box-shadow:0 8px 32px rgba(0,0,0,0.3); }
        .menu-header { background:linear-gradient(135deg, #8b4513 0%, #d2691e 100%); color:#fff; padding:32px 24px; position:relative; }
        .close-btn { position:absolute; top:16px; right:16px; background:rgba(255,255,255,0.2); border:none; color:#fff; font-size:24px; cursor:pointer; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:background-color 0.2s ease; }
        .close-btn:hover { background:rgba(255,255,255,0.3); }
        .menu-restaurant-name { font-size:32px; font-weight:900; margin-bottom:8px; letter-spacing:-1px; }
        .menu-restaurant-description { font-size:16px; opacity:0.9; }
        .menu-items { padding:24px; }
        .menu-section-title { font-size:24px; font-weight:700; color:#000; margin-bottom:16px; letter-spacing:-0.5px; }
        .menu-item { display:flex; justify-content:space-between; align-items:flex-start; padding:20px 0; border-bottom:1px solid #eee; transition:background-color 0.2s ease; }
        .menu-item:hover { background:#fafafa; margin:0 -24px; padding:20px 24px; }
        .item-details { flex:1; margin-right:16px; }
        .item-name { font-size:18px; font-weight:600; color:#000; margin-bottom:4px; letter-spacing:-0.2px; }
        .item-description { font-size:14px; color:#737373; line-height:1.4; margin-bottom:8px; }
        .item-price { font-size:16px; font-weight:600; color:#000; }
        .deluxe-badge { background:#ffd700; color:#000; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:700; margin-left:8px; letter-spacing:0.5px; }
        .add-btn { background:#000; color:#fff; border:none; padding:12px 24px; border-radius:500px; cursor:pointer; font-weight:600; font-size:16px; transition:background-color 0.2s ease; flex-shrink:0; }
        .add-btn:hover { background:#333; }
        .cart-content { max-width:600px; max-height:80vh; overflow-y:auto; }
        .cart-header { background:#000; color:#fff; padding:24px; display:flex; justify-content:space-between; align-items:center; }
        .cart-title { font-size:24px; font-weight:700; letter-spacing:-0.5px; }
        .cart-items { padding:24px; max-height:400px; overflow-y:auto; }
        .cart-item { display:flex; justify-content:space-between; align-items:center; padding:16px 0; border-bottom:1px solid #eee; }
        .cart-item:last-child { border-bottom:none; }
        .cart-item-info { flex:1; }
        .cart-item-name { font-size:16px; font-weight:600; color:#000; margin-bottom:4px; }
        .cart-item-price { font-size:14px; color:#737373; }
        .quantity-controls { display:flex; align-items:center; gap:12px; }
        .qty-btn { background:#eee; border:none; width:32px; height:32px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:600; color:#000; transition:background-color 0.2s ease; }
        .qty-btn:hover { background:#ddd; }
        .qty-number { font-size:16px; font-weight:600; color:#000; min-width:20px; text-align:center; }
        .cart-total { padding:24px; border-top:1px solid #eee; background:#fafafa; display:grid; gap:12px; }
        .total-row { display:flex; justify-content:space-between; align-items:center; }
        .total-label { font-size:18px; font-weight:600; color:#000; }
        .total-amount { font-size:18px; font-weight:700; color:#000; }
        .field { display:grid; gap:6px; }
        .label { font-size:13px; color:#333; font-weight:600; }
        .input { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; }
        .empty-cart { text-align:center; padding:48px 24px; }
        .empty-cart-icon { font-size:48px; margin-bottom:16px; opacity:0.5; }
        .empty-cart-text { font-size:18px; color:#737373; margin-bottom:8px; }
        .empty-cart-subtext { font-size:14px; color:#9a9a9a; }
        .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:12px 16px; border-radius:8px; z-index:4000; box-shadow:0 6px 24px rgba(0,0,0,0.3); display:none; font-weight:600; }
        @media (max-width:768px) {
            .hero-title { font-size:40px; }
            .restaurants-grid { grid-template-columns:1fr; }
            .menu-content, .cart-content { margin:20px; max-width:calc(100% - 40px); }
            .menu-header { padding:24px 20px; }
            .menu-restaurant-name { font-size:28px; }
            .menu-items { padding:20px; }
            .menu-item:hover { margin:0 -20px; padding:20px; }
        }
    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <div class="logo">Uber Eats</div>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Buscar restaurantes y platillos" />
        </div>
        <div class="header-actions">
            <a class="btn link-btn" href="pedidos.html">Pedidos</a>
            <button id="statusBtn" class="btn secondary-btn" style="display:none;" onclick="openStatusModal()">Estado</button>
            <button class="btn" onclick="openCart()">Carrito <span class="cart-count" id="cartCount">0</span></button>
        </div>
    </div>
</header>

<main class="main-content">
    <section class="hero-section">
        <h1 class="hero-title">Comida a domicilio y para llevar</h1>
        <p class="hero-subtitle">La comida que te gusta, entregada con Uber</p>
    </section>

    <section class="restaurants-section">
        <h2 class="section-title">Restaurantes cercanos</h2>

        <div class="restaurants-grid">
            <div class="restaurant-card closed">
                <div class="restaurant-image burger-joint-bg">
                    üçî
                    <div class="closed-overlay">CERRADO</div>
                </div>
                <div class="restaurant-info">
                    <h3 class="restaurant-name">Burger Joint</h3>
                    <div class="restaurant-meta">
                        <span class="rating">4.5</span>
                        <span class="delivery-info">‚Ä¢ Cerrado ‚Ä¢ Hamburguesas</span>
                    </div>
                    <p class="restaurant-description">Hamburguesas gourmet y comida r√°pida americana</p>
                </div>
            </div>

            <div class="restaurant-card" onclick="openMenu()">
                <div class="restaurant-image leons-bbq-bg">ü•©</div>
                <div class="restaurant-info">
                    <h3 class="restaurant-name">Leon's BBQ</h3>
                    <div class="restaurant-meta">
                        <span class="rating">4.8</span>
                        <span class="delivery-info">‚Ä¢ 25-40 min ‚Ä¢ $2.99 de entrega ‚Ä¢ Parrilla</span>
                    </div>
                    <p class="restaurant-description">Especialistas en carnes a la parrilla y comida internacional</p>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Menu Modal -->
<div class="menu-modal" id="menuModal">
    <div class="menu-content">
        <div class="menu-header">
            <button class="close-btn" onclick="closeMenu()">&times;</button>
            <h2 class="menu-restaurant-name">Leon's BBQ</h2>
            <p class="menu-restaurant-description">Especialistas en carnes a la parrilla y comida internacional</p>
        </div>
        <div class="menu-items">
            <h3 class="menu-section-title">Especialidades</h3>

            <div class="menu-item">
                <div class="item-details">
                    <h4 class="item-name">Arroz con Pollo</h4>
                    <p class="item-description">Delicioso arroz con pollo tradicional, preparado con especias de la casa</p>
                    <span class="item-price">$5.00</span>
                </div>
                <button class="add-btn" onclick="addToCart('Arroz con Pollo', 5.00)">Agregar</button>
            </div>

            <div class="menu-item">
                <div class="item-details">
                    <h4 class="item-name">Hamburguesa Cl√°sica</h4>
                    <p class="item-description">Hamburguesa jugosa con todos los acompa√±amientos tradicionales</p>
                    <span class="item-price">$7.78</span>
                </div>
                <button class="add-btn" onclick="addToCart('Hamburguesa Cl√°sica', 7.78)">Agregar</button>
            </div>

            <div class="menu-item">
                <div class="item-details">
                    <h4 class="item-name">Carne Premium <span class="deluxe-badge">DELUXE</span></h4>
                    <p class="item-description">Corte premium de carne a la parrilla, preparado al punto perfecto</p>
                    <span class="item-price">$20.00</span>
                </div>
                <button class="add-btn" onclick="addToCart('Carne Premium', 20.00)">Agregar</button>
            </div>

            <div class="menu-item">
                <div class="item-details">
                    <h4 class="item-name">Filet Mignon</h4>
                    <p class="item-description">El corte m√°s tierno y jugoso de nuestra selecci√≥n</p>
                    <span class="item-price">$15.00</span>
                </div>
                <button class="add-btn" onclick="addToCart('Filet Mignon', 15.00)">Agregar</button>
            </div>

            <div class="menu-item">
                <div class="item-details">
                    <h4 class="item-name">Pasa</h4>
                    <p class="item-description">Postre tradicional con pasas, perfecto para cerrar tu comida</p>
                    <span class="item-price">$3.00</span>
                </div>
                <button class="add-btn" onclick="addToCart('Pasa', 3.00)">Agregar</button>
            </div>

            <div class="menu-item">
                <div class="item-details">
                    <h4 class="item-name">Dosirak</h4>
                    <p class="item-description">Caja de comida coreana completa con arroz y acompa√±amientos</p>
                    <span class="item-price">$4.56</span>
                </div>
                <button class="add-btn" onclick="addToCart('Dosirak', 4.56)">Agregar</button>
            </div>

            <div class="menu-item">
                <div class="item-details">
                    <h4 class="item-name">Huevada Especial</h4>
                    <p class="item-description">Especialidad de la casa preparada con huevos frescos y ingredientes selectos</p>
                    <span class="item-price">$6.00</span>
                </div>
                <button class="add-btn" onclick="addToCart('Huevada Especial', 6.00)">Agregar</button>
            </div>
        </div>
    </div>
</div>

<!-- Cart Modal -->
<div class="cart-modal" id="cartModal">
    <div class="cart-content">
        <div class="cart-header">
            <h3 class="cart-title">Tu pedido</h3>
            <button class="close-btn" onclick="closeCart()">&times;</button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="empty-cart">
                <div class="empty-cart-icon">üõí</div>
                <p class="empty-cart-text">Tu carrito est√° vac√≠o</p>
                <p class="empty-cart-subtext">Agrega platillos de Leon's BBQ para comenzar</p>
            </div>
        </div>
        <div class="cart-total" id="cartTotal" style="display:none;">
            <div class="field">
                <label class="label" for="customerNameInput">Tu nombre</label>
                <input class="input" id="customerNameInput" placeholder="Ej: Juan P√©rez" />
            </div>
            <div class="total-row">
                <span class="total-label">Total</span>
                <span class="total-amount" id="totalAmount">$0.00</span>
            </div>
            <button class="btn" onclick="checkout()">Ir al pago</button>
        </div>
    </div>
</div>

<!-- Pago Exitoso (simulaci√≥n) -->
<div class="menu-modal" id="paymentModal">
    <div class="menu-content">
        <div class="menu-header" style="background:linear-gradient(135deg, #06c755 0%, #04a343 100%);">
            <button class="close-btn" onclick="closePaymentModal()">&times;</button>
            <h2 class="menu-restaurant-name">Pago exitoso</h2>
            <p class="menu-restaurant-description">Simulaci√≥n / juego ‚Äî no es un pago real</p>
        </div>
        <div class="menu-items">
            <p id="paymentSummary" style="margin-bottom:16px;"></p>
            <button class="add-btn" onclick="openStatusModal()">Ver estado del pedido</button>
        </div>
    </div>
</div>

<!-- Estado del Pedido -->
<div class="menu-modal" id="statusModal">
    <div class="menu-content">
        <div class="menu-header" style="background:linear-gradient(135deg, #276ef1 0%, #1747a6 100%);">
            <button class="close-btn" onclick="closeStatusModal()">&times;</button>
            <h2 class="menu-restaurant-name">Estado de tu pedido</h2>
            <p class="menu-restaurant-description">Sincronizado con Google Sheets</p>
        </div>
        <div class="menu-items" id="statusBody"></div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSUvM8mMofBxnsPy8bPUVsVeGrKli1sY5e1NEadLR0VrxE1cq5gPhlMPtXb6_ZvpAIog/exec';
const GVIZ_SHEET_ID = '1y78r564-YWA2haXgtQ9iSZI-m8_h_bw-rMeibqpcXdY';
const GVIZ_GID = '883931380';

let cart = [];
let currentOrder = null;
let pollTimer = null;

function formatCurrency(n){ return `$${Number(n||0).toFixed(2)}`; }
function uid(){ return 'ORD-' + Date.now() + '-' + Math.floor(Math.random()*100000); }
function showToast(msg){
  const el = document.getElementById('toast');
  if(!el) return;
  el.textContent = msg; el.style.display='block';
  setTimeout(()=>{ el.style.display='none'; }, 1800);
}
function setStatusButtonVisible(v){
  const el = document.getElementById('statusBtn');
  if(el) el.style.display = v ? 'inline-flex' : 'none';
}

// GViz JSONP helper
function jsonpGviz(url){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Date.now()+'_'+Math.floor(Math.random()*1e6);
    const s=document.createElement('script');
    const cleanup=()=>{ try{delete window[cb]}catch(_){};
      if(s&&s.parentNode) s.parentNode.removeChild(s); clearTimeout(to); };
    window[cb]=(payload)=>{ cleanup(); resolve(payload); };
    s.onerror=()=>{ cleanup(); reject(new Error('GViz JSONP error')); };
    s.src = url + (url.includes('?')?'&':'?') + 'tqx=' + encodeURIComponent('responseHandler:'+cb) + '&_=' + Date.now();
    document.body.appendChild(s);
    const to=setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, 10000);
  });
}
async function fetchFromGviz(){
  const base = `https://docs.google.com/spreadsheets/d/${GVIZ_SHEET_ID}/gviz/tq`;
  const url = `${base}?gid=${encodeURIComponent(GVIZ_GID)}&tq=${encodeURIComponent('select A,B,C,D,E,F,G')}`;
  const data = await jsonpGviz(url);
  if(!data || !data.table || !Array.isArray(data.table.rows)) throw new Error('GViz sin datos');
  const rows = data.table.rows.map(r=>{
    const c = r.c || [];
    return {
      id: c[0]?.v ?? '',
      timestamp: c[1]?.v ?? '',
      restaurant: c[2]?.v ?? '',
      items: c[3]?.v ?? '',
      total: Number(c[4]?.v ?? 0),
      status: c[5]?.v ?? '',
      customerName: c[6]?.v ?? ''
    };
  });
  return rows;
}

function openMenu(){ const m=document.getElementById('menuModal'); if(m){ m.style.display='block'; document.body.style.overflow='hidden'; } }
function closeMenu(){ const m=document.getElementById('menuModal'); if(m){ m.style.display='none'; document.body.style.overflow='auto'; } }
function openCart(){
  const m=document.getElementById('cartModal'); if(m){ m.style.display='block'; document.body.style.overflow='hidden'; }
  const savedName = localStorage.getItem('customerName') || '';
  const input = document.getElementById('customerNameInput');
  if(input && !input.value) input.value = savedName;
  updateCartDisplay();
}
function closeCart(){ const m=document.getElementById('cartModal'); if(m){ m.style.display='none'; document.body.style.overflow='auto'; } }

function addToCart(name, price){
  const ex = cart.find(i=>i.name===name);
  if(ex){ ex.quantity++; } else { cart.push({name,price,quantity:1}); }
  updateCartCount();

  const btn = event?.target;
  if(btn){
    const t = btn.textContent;
    btn.textContent='Agregado'; btn.style.background='#06c755';
    setTimeout(()=>{ btn.textContent=t; btn.style.background='#000'; },1000);
  }
}
function updateCartCount(){
  const total = cart.reduce((s,i)=>s+i.quantity,0);
  const cc = document.getElementById('cartCount');
  if(!cc) return;
  cc.textContent = total;
  cc.style.display = total>0 ? 'flex' : 'none';
}
function updateCartDisplay(){
  const container = document.getElementById('cartItems');
  const cartTotal = document.getElementById('cartTotal');
  const totalEl = document.getElementById('totalAmount');
  if(!container || !cartTotal || !totalEl) return;

  if(cart.length===0){
    container.innerHTML = `
      <div class="empty-cart">
        <div class="empty-cart-icon">üõí</div>
        <p class="empty-cart-text">Tu carrito est√° vac√≠o</p>
        <p class="empty-cart-subtext">Agrega platillos de Leon's BBQ para comenzar</p>
      </div>`;
    cartTotal.style.display='none';
    return;
  }
  let total=0;
  container.innerHTML = cart.map(item=>{
    total += item.price*item.quantity;
    return `
      <div class="cart-item">
        <div class="cart-item-info">
          <div class="cart-item-name">${item.name}</div>
          <div class="cart-item-price">${formatCurrency(item.price)}</div>
        </div>
        <div class="quantity-controls">
          <button class="qty-btn" onclick="changeQuantity('${item.name}',-1)">‚àí</button>
          <span class="qty-number">${item.quantity}</span>
          <button class="qty-btn" onclick="changeQuantity('${item.name}',1)">+</button>
        </div>
      </div>`;
  }).join('');
  totalEl.textContent = formatCurrency(total);
  cartTotal.style.display='block';
}
function changeQuantity(name,delta){
  const it = cart.find(i=>i.name===name);
  if(!it) return;
  it.quantity += delta;
  if(it.quantity<=0) cart = cart.filter(i=>i.name!==name);
  updateCartCount();
  updateCartDisplay();
}

async function checkout(){
  if(cart.length===0) return;
  const name = (document.getElementById('customerNameInput')?.value || '').trim();
  if(!name){ alert('Por favor ingresa tu nombre'); return; }
  localStorage.setItem('customerName', name);

  const total = cart.reduce((s,i)=>s+i.price*i.quantity,0);
  const orderId = uid();
  const order = {
    id:orderId,
    timestamp: new Date().toISOString(),
    restaurant: "Leon's BBQ",
    items: cart.map(i=>({name:i.name, price:i.price, quantity:i.quantity})),
    total: Number(total.toFixed(2)),
    status:'Recibido',
    customerName: name
  };

  currentOrder = order;
  localStorage.setItem('currentOrder', JSON.stringify(order));
  setStatusButtonVisible(true);

  try{
    const body = new URLSearchParams();
    body.append('payload', JSON.stringify(order));
    await fetch(APPSCRIPT_URL, { method:'POST', body, cache:'no-cache', mode:'no-cors' });
  }catch(e){ /* silencioso */ }

  const sum = document.getElementById('paymentSummary');
  if(sum) sum.textContent = `Pedido ${order.id} confirmado para ${name}. Total: ${formatCurrency(order.total)}. ¬°Gracias!`;
  openPaymentModal();

  cart = [];
  updateCartCount();
  closeCart();
  startAutoRefresh();
}

function openPaymentModal(){ const m=document.getElementById('paymentModal'); if(m){ m.style.display='block'; document.body.style.overflow='hidden'; } }
function closePaymentModal(){ const m=document.getElementById('paymentModal'); if(m){ m.style.display='none'; document.body.style.overflow='auto'; } }
function openStatusModal(){ renderStatusBody(); const m=document.getElementById('statusModal'); if(m){ m.style.display='block'; document.body.style.overflow='hidden'; } }
function closeStatusModal(){ const m=document.getElementById('statusModal'); if(m){ m.style.display='none'; document.body.style.overflow='auto'; } }

function renderStatusBody(latest){
  const c = document.getElementById('statusBody');
  if(!c) return;
  if(!currentOrder){ c.innerHTML='<p>No tienes un pedido en curso.</p>'; return; }
  const st = latest?.status || currentOrder.status || 'Recibido';
  const itemsText = (currentOrder.items||[]).map(i=>`${i.quantity}x ${i.name} (${formatCurrency(i.price)})`).join('; ');
  c.innerHTML = `
    <div style="display:grid; gap:8px;">
      <div><strong>ID:</strong> ${currentOrder.id}</div>
      <div><strong>Nombre:</strong> ${currentOrder.customerName||'-'}</div>
      <div><strong>Restaurante:</strong> ${currentOrder.restaurant}</div>
      <div><strong>Items:</strong> ${itemsText||'-'}</div>
      <div><strong>Total:</strong> ${formatCurrency(currentOrder.total)}</div>
      <div><strong>Estado:</strong> ${st}</div>
      <div style="font-size:12px; color:#666;"><em>Se actualiza cada 2s.</em></div>
    </div>`;
}

async function pollOrderStatus(){
  if(!currentOrder) return;
  try{
    const rows = await fetchFromGviz();
    const row = rows.find(r => String(r.id) === String(currentOrder.id));
    if(row && row.status){
      if(row.status !== currentOrder.status){
        currentOrder.status = row.status;
        localStorage.setItem('currentOrder', JSON.stringify(currentOrder));
        showToast(`Estado actualizado: ${row.status}`);
      }
      if(document.getElementById('statusModal')?.style.display==='block'){
        renderStatusBody(row);
      }
    }
  }catch(_){ /* silencioso */ }
}
function startAutoRefresh(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(pollOrderStatus, 2000);
}

// eventos
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){ closeMenu(); closeCart(); closePaymentModal(); closeStatusModal(); }
});
document.getElementById('menuModal')?.addEventListener('click',(e)=>{ if(e.target===e.currentTarget) closeMenu(); });
document.getElementById('cartModal')?.addEventListener('click',(e)=>{ if(e.target===e.currentTarget) closeCart(); });
document.getElementById('paymentModal')?.addEventListener('click',(e)=>{ if(e.target===e.currentTarget) closePaymentModal(); });
document.getElementById('statusModal')?.addEventListener('click',(e)=>{ if(e.target===e.currentTarget) closeStatusModal(); });

document.querySelector('.search-input')?.addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  document.querySelectorAll('.restaurant-card').forEach(card=>{
    const nameEl = card.querySelector('.restaurant-name');
    if(!nameEl) return;
    card.style.display = nameEl.textContent.toLowerCase().includes(q) ? 'block' : 'none';
  });
});

// init
(function init(){
  try{
    const saved = localStorage.getItem('currentOrder');
    if(saved){
      currentOrder = JSON.parse(saved);
      setStatusButtonVisible(true);
      startAutoRefresh();
    }else{
      setStatusButtonVisible(false);
    }
  }catch(_){ setStatusButtonVisible(false); }
})();
</script>
</body>
</html>
